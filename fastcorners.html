<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>chapter 3, feature detection jsfeat</title>
    <link rel="stylesheet" href="css/cvw.css">
    <script src="js/jsfeat-min.js"></script>
    <script src="js/druid.min.js"></script>
</head>

<body>
    <div id="images" class="canvas-parent">
        <canvas id="initCanvas" class="canvas-img"></canvas>
    </div>

    <script>
        var canvas = document.getElementById('initCanvas'),
            context = canvas.getContext('2d'),
            image = new Image(),
            cols,
            rows;

        image.src = 'img/23.png';

        function findFeatures() {
            var threshold = 30;
            jsfeat.fast_corners.set_threshold(threshold);
            var imageData = context.getImageData(0, 0, cols, rows);

            var dataBuffer = new jsfeat.data_t(cols * rows, imageData.data.buffer);
            var mat = new jsfeat.matrix_t(cols, rows, jsfeat.U8C4_t, dataBuffer);
            var matGray = new jsfeat.matrix_t(mat.cols, mat.rows, jsfeat.U8C1_t);
            jsfeat.imgproc.grayscale(mat.data, mat.cols, mat.rows, matGray);
            var matBlurred = new jsfeat.matrix_t(mat.cols, mat.rows, jsfeat.U8C1_t);

            jsfeat.imgproc.gaussian_blur(matGray, matBlurred, 3);
            var corners = [];
            var i = cols * rows;
            while (--i >= 0) {
                corners[i] = new jsfeat.keypoint_t(0, 0, 0, 0, -1);
            }

            var count = jsfeat.fast_corners.detect(matBlurred, corners, 3);

            console.log(corners);
            console.log(count);
            console.log(corners.slice(0, count));
            const X = druid.Matrix.from(corners.slice(0, count));
            console.log("matrix druid");
            console.log(X);

            var new_dimensions = 2
            my_dr = new druid.MDS(X, new_dimensions)
            var bow_all_dr = my_dr.transform().to2dArray // computamos la reduccion de dimensionalidad y obtenemos un vector de 2 dimensiones

            console.log(bow_all_dr);


            for (i = 0; i < count; i++) {
                context.fillStyle = '#0f0';
                context.fillRect(corners[i].x, corners[i].y, 3, 3);
            }
        }

        window.onload = function () {
            cols = image.width;
            rows = image.height;
            canvas.width = cols;
            canvas.height = rows;
            context.drawImage(image, 0, 0, image.width, image.height);
            findFeatures();
        }
    </script>
</body>

</html>